#!/bin/bash

# Declare test counters
declare -i tc=0  # Counter for the number of test cases executed
declare -i fails=0  # Counter for the number of failed test cases

############################################
# Function to run a single test
############################################
test() {
    tc=tc+1  # Increment test case counter

    # Input arguments for the test function
    local COMMAND=$1  # The command or program to test
    local INP=$2  # File containing the test input
    local EX_OUT=$3  # File containing the expected standard output
    local EX_ERR=$4  # File containing the expected standard error

    # Determine the expected return code
    EX_RET=1  # Default expected return code for error cases
    if [[ ! -s $EX_ERR ]]; then  # If the expected error file is empty, assume success
        EX_RET=0  # Set expected return code for successful execution
    fi

    # Execute the command with the test input
    $COMMAND < $INP > test_out.txt 2> test_err.txt  # Redirect standard output and error to temporary files
    RET=$?  # Capture the return code of the command

    # Check if the return code matches the expected value
    if [[ $RET != $EX_RET ]]; then
        echo "TC $tc Failed (Return Code)"  # Log failure for mismatched return code
        echo "Returned $RET, Expected $EX_RET"  # Display the mismatch details
        echo "-----------"  # Separator for clarity in logs
        fails=$fails+1  # Increment failure counter
        return
    fi

    # Check if the actual standard output matches the expected output
    DIFF=$(diff test_out.txt $EX_OUT)  # Compare actual and expected standard output
    if [[ $DIFF != '' ]]; then
        echo "TC $tc Failed (Standard Output)"  # Log failure for mismatched standard output
        echo "$DIFF"  # Display the differences
        echo "-----------"  # Separator for clarity in logs
        fails=$fails+1  # Increment failure counter
        return
    fi

    # Check if the actual standard error matches the expected error
    DIFF=$(diff test_err.txt $EX_ERR)  # Compare actual and expected standard error
    if [[ $DIFF != '' ]]; then
        echo "TC $tc Failed (Standard Error)"  # Log failure for mismatched standard error
        echo "$DIFF"  # Display the differences
        echo "-----------"  # Separator for clarity in logs
        fails=$fails+1  # Increment failure counter
        return
    fi

    # Log success if all checks pass
    echo "TC $tc Passed"  # Indicate successful test case execution
}

############################################
# Test Cases
############################################

# Test 1: Player wins with higher value
test './testing_game_result' './build_testing/input/inp1.txt' './build_testing/output/out1.txt' './build_testing/error/empty.txt'

# Test 2: Dealer wins
test './testing_game_result' './build_testing/input/inp2.txt' './build_testing/output/out2.txt' './build_testing/error/empty.txt'

# Test 3: Player busts
test './testing_game_result' './build_testing/input/inp3.txt' './build_testing/output/out3.txt' './build_testing/error/empty.txt'

# Test 4: 5-Card Charlie
test './testing_game_result' './build_testing/input/inp4.txt' './build_testing/output/out4.txt' './build_testing/error/empty.txt'

# Test 5: Blackjack win
test './testing_game_result' './build_testing/input/inp5.txt' './build_testing/output/out5.txt' './build_testing/error/empty.txt'

# Test 6: Invalid bet amount
test './testing_game_result' './build_testing/input/inp6.txt' './build_testing/output/out6.txt' './build_testing/error/err6.txt'

# Test 7: Invalid input
test './testing_game_result' './build_testing/input/inp7.txt' './build_testing/output/out7.txt' './build_testing/error/err7.txt'

# Test 8: Push result
test './testing_game_result' './build_testing/input/inp8.txt' './build_testing/output/out8.txt' './build_testing/error/empty.txt'

# Test 9: Test ace_adjuster
test './special_case_coverage' './build_testing/input/inp1_special_case.txt' './build_testing/output/out1_special_case.txt' './build_testing/error/empty.txt'

# Test 10: Test double_down
test './special_case_coverage' './build_testing/input/inp2_special_case.txt' './build_testing/output/out2_special_case.txt' './build_testing/error/empty.txt'

# Test 11: Test double_down when card count is not equals 2
test './special_case_coverage' './build_testing/input/inp3_special_case.txt' './build_testing/output/out3_special_case.txt' './build_testing/error/empty.txt'

# Test 12: Test check_split
test './special_case_coverage' './build_testing/input/inp4_special_case.txt' './build_testing/output/out4_special_case.txt' './build_testing/error/empty.txt'

# Test 13: Test handle_split
test './special_case_coverage' './build_testing/input/inp5_special_case.txt' './build_testing/output/out5_special_case.txt' './build_testing/error/empty.txt'

# Test 14: Test handle_split when playerHand.value = 1
test './special_case_coverage' './build_testing/input/inp6_special_case.txt' './build_testing/output/out6_special_case.txt' './build_testing/error/empty.txt'

# Test 15: Test split_ace_adjuster
test './special_case_coverage' './build_testing/input/inp7_special_case.txt' './build_testing/output/out7_special_case.txt' './build_testing/error/empty.txt'

# Test 16: Comprehensive test for combined functionality
test './special_case_coverage' './build_testing/input/inp8_special_case.txt' './build_testing/output/out8_special_case.txt' './build_testing/error/empty.txt'

############################################
# Clean up
############################################

rm test_out.txt test_err.txt  # Remove temporary files created during test execution

# Exit script with the number of failed test cases
exit $fails  # Return the total count of failed test cases as the exit status
